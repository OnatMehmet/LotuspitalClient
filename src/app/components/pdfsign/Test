# ğŸ“¦ Toplu PDF Ä°mzalama Sistemi - TÃ¼m Dosyalar

## ğŸ“ Dosya 1: websocket-esignature.service.ts

**Konum:** `src/app/services/websocket-esignature.service.ts`

```typescript
import { Injectable } from '@angular/core';
import { Subject, BehaviorSubject } from 'rxjs';

export interface EImzaResponse {
  data: string;
  islemId: string;
  kullaniciId: string;
  hataMesaji: string;
  sertifikaId: string;
  akilliKartIsim: string;
}

export interface DllOption {
  value: string;
  label: string;
}

@Injectable({
  providedIn: 'root'
})
export class WebSocketESignatureService {
  private webSocket: WebSocket = null;
  private messageSubject = new Subject<EImzaResponse>();
  private connectionSubject = new BehaviorSubject<boolean>(false);
  
  private readonly address: string = '127.0.0.1';
  private readonly port: string = '5000';
  private readonly uri: string = '';
  private kullaniciId: string = '';

  public readonly dllOptions: DllOption[] = [
    { value: 'akisp11.dll', label: 'Turktrust, Tubitak' },
    { value: 'eTPKCS11.dll', label: 'E-gÃ¼ven' },
    { value: 'aetpkss1.dll', label: 'E-TuÄŸra' }
  ];

  constructor() { }

  connectAsync(kullaniciId: string): Promise<boolean> {
    this.kullaniciId = kullaniciId;

    if (this.webSocket && this.webSocket.readyState === WebSocket.OPEN) {
      console.log('WebSocket zaten baÄŸlÄ±');
      return Promise.resolve(true);
    }

    if (this.webSocket) {
      this.webSocket.close();
    }

    const path = 'ws://' + this.address + ':' + this.port + '/ws/' + this.uri;
    const that = this;
    
    return new Promise((resolve, reject) => {
      try {
        this.webSocket = new WebSocket(path, 'sec-websocket-protocol');

        this.webSocket.onopen = function() {
          console.log('âœ… TurkTrust WebSocket baÄŸlandÄ±:', path);
          that.connectionSubject.next(true);
          resolve(true);
        };

        this.webSocket.onmessage = function(event) {
          try {
            const response: EImzaResponse = JSON.parse(event.data);
            console.log('ğŸ“¨ Mesaj alÄ±ndÄ±:', response);
            that.messageSubject.next(response);
          } catch (error) {
            console.error('Mesaj parse hatasÄ±:', error);
          }
        };

        this.webSocket.onerror = function(error) {
          console.error('âŒ WebSocket hatasÄ±:', error);
          that.connectionSubject.next(false);
          reject(new Error('WebSocket baÄŸlantÄ± hatasÄ±'));
        };

        this.webSocket.onclose = function() {
          console.log('ğŸ”’ WebSocket baÄŸlantÄ±sÄ± kapandÄ±');
          that.connectionSubject.next(false);
        };

        setTimeout(() => {
          if (that.webSocket.readyState !== WebSocket.OPEN) {
            that.webSocket.close();
            reject(new Error('WebSocket baÄŸlantÄ± zaman aÅŸÄ±mÄ± (5 saniye)'));
          }
        }, 5000);

      } catch (error) {
        console.error('WebSocket oluÅŸturma hatasÄ±:', error);
        this.connectionSubject.next(false);
        reject(error);
      }
    });
  }

  private sendData(stringData: string, islemId: string): void {
    if (!this.webSocket || this.webSocket.readyState !== WebSocket.OPEN) {
      throw new Error('WebSocket baÄŸlantÄ±sÄ± aÃ§Ä±k deÄŸil');
    }

    const message = JSON.stringify({
      data: stringData,
      kullaniciId: this.kullaniciId,
      received: '',
      islemId: islemId,
      sertifikaId: 'sertifikaId'
    });

    this.webSocket.send(message);
    console.log('ğŸ“¤ Mesaj gÃ¶nderildi:', islemId);
  }

  getMessages() {
    return this.messageSubject.asObservable();
  }

  getConnectionStatus() {
    return this.connectionSubject.asObservable();
  }

  disconnect(): void {
    if (this.webSocket) {
      console.log('ğŸ”’ WebSocket baÄŸlantÄ±sÄ± kapatÄ±lÄ±yor...');
      this.webSocket.close();
      this.webSocket = null;
      this.connectionSubject.next(false);
    }
  }

  sendCardType(dllName: string): void {
    this.sendData(dllName, '9');
  }

  signWithCAdESUI(base64Hash: string, useCAdES: boolean = false): void {
    this.sendData(useCAdES ? 'true' : 'false', '14');
    this.sendData(base64Hash, '12');
  }
}
```

---

## ğŸ“ Dosya 2: pdf-preview.component.ts

**Konum:** `src/app/components/pdf-preview/pdf-preview.component.ts`

```typescript
import { Component, OnInit, ViewChild, Input, Output, EventEmitter } from '@angular/core';
import { IFileUploadService } from '../../services/ifileuploadservice';
import { map } from 'rxjs/operators';

@Component({
  selector: 'app-pdf-preview',
  templateUrl: './pdf-preview.component.html',
  styleUrls: ['./pdf-preview.component.scss']
})
export class PdfPreviewComponent implements OnInit {

  @Input() dataId: string;
  @Input() reportName: string;
  @Input() zIndex: number = 1000;
  
  @Output() onDecision = new EventEmitter<{ dataId: string, decision: 'save' | 'cancel', pdfBytes?: Blob }>();
  
  public errorMessage: string;
  public pdfBytes: Blob;
  public isLoading: boolean = true;
  
  @ViewChild('pdfViewer') public pdfViewer;

  constructor(private fileUploadService: IFileUploadService) { }

  ngOnInit() {
    if (this.dataId) {
      this.downloadFile(this.dataId).subscribe(
        (res) => {
          this.pdfBytes = res;
          this.isLoading = false;
          
          if (this.pdfViewer) {
            this.pdfViewer.pdfSrc = res;
            this.pdfViewer.refresh();
          }
        },
        (err) => {
          this.errorMessage = 'PDF yÃ¼klenirken hata oluÅŸtu';
          this.isLoading = false;
        }
      );
    }
  }

  private downloadFile(dataId: string): any {
    const input = { dataId: dataId, mimeType: "application/pdf" };
    return this.fileUploadService.downloadBinaryData(input.dataId, input.mimeType).pipe(
      map((result: any) => {
        return new Blob([result.body]);
      })
    );
  }

  onSave() {
    this.onDecision.emit({
      dataId: this.dataId,
      decision: 'save',
      pdfBytes: this.pdfBytes
    });
  }

  onCancel() {
    this.onDecision.emit({
      dataId: this.dataId,
      decision: 'cancel'
    });
  }

}
```

---

## ğŸ“ Dosya 3: pdf-preview.component.html

**Konum:** `src/app/components/pdf-preview/pdf-preview.component.html`

```html
<div class="pdf-preview-popup" [style.z-index]="zIndex">
  
  <div class="overlay"></div>
  
  <div class="pdf-container">
    
    <div class="header">
      <h3>{{ reportName || 'PDF Ä°nceleme' }}</h3>
    </div>

    <div class="loading" *ngIf="isLoading">
      <div class="spinner-border text-primary"></div>
      <p>PDF yÃ¼kleniyor...</p>
    </div>

    <div class="alert alert-danger" *ngIf="errorMessage">
      <i class="fa fa-exclamation-circle"></i>
      {{ errorMessage }}
    </div>

    <div class="pdf-viewer-container" *ngIf="!isLoading && !errorMessage">
      <pdf-viewer 
        #pdfViewer
        [render-text]="true"
        [original-size]="false"
        [show-all]="true"
        style="width: 100%; height: 500px;">
      </pdf-viewer>
    </div>

    <div class="action-buttons" *ngIf="!isLoading">
      <button class="btn btn-success" (click)="onSave()">
        <i class="fa fa-check"></i>
        Kaydet
      </button>

      <button class="btn btn-secondary" (click)="onCancel()">
        <i class="fa fa-times"></i>
        VazgeÃ§
      </button>
    </div>

  </div>
</div>
```

---

## ğŸ“ Dosya 4: pdf-preview.component.scss

**Konum:** `src/app/components/pdf-preview/pdf-preview.component.scss`

```scss
.pdf-preview-popup {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  
  .overlay {
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: -1;
  }
  
  .pdf-container {
    background: white;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
    width: 90%;
    max-width: 900px;
    max-height: 90vh;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    
    .header {
      padding: 20px;
      background: #007bff;
      color: white;
      border-bottom: 1px solid #ddd;
      
      h3 {
        margin: 0;
        font-size: 1.25rem;
      }
    }
    
    .loading {
      padding: 40px;
      text-align: center;
      
      .spinner-border {
        width: 3rem;
        height: 3rem;
      }
      
      p {
        margin-top: 15px;
        color: #666;
      }
    }
    
    .alert {
      margin: 20px;
      padding: 15px;
      border-radius: 4px;
      
      &.alert-danger {
        background: #f8d7da;
        border: 1px solid #f5c6cb;
        color: #721c24;
      }
      
      i {
        margin-right: 8px;
      }
    }
    
    .pdf-viewer-container {
      flex: 1;
      overflow: auto;
      padding: 20px;
      background: #f5f5f5;
    }
    
    .action-buttons {
      padding: 20px;
      border-top: 1px solid #ddd;
      display: flex;
      gap: 12px;
      justify-content: flex-end;
      background: white;
      
      .btn {
        padding: 10px 24px;
        font-size: 1rem;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.2s;
        display: flex;
        align-items: center;
        gap: 8px;
        
        i {
          font-size: 1rem;
        }
        
        &.btn-success {
          background: #28a745;
          color: white;
          
          &:hover {
            background: #218838;
            transform: translateY(-1px);
            box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
          }
        }
        
        &.btn-secondary {
          background: #6c757d;
          color: white;
          
          &:hover {
            background: #545b62;
          }
        }
      }
    }
  }
}
```

---

## ğŸ“ Dosya 5: report-list.component.ts

**Konum:** `src/app/components/report-list/report-list.component.ts`

```typescript
import { Component, OnInit } from '@angular/core';
import { IFileUploadService } from '../../services/ifileuploadservice';
import { WebSocketESignatureService } from '../../services/websocket-esignature.service';

interface ReportItem {
  id: number;
  name: string;
  dataId: string;
  selected: boolean;
  approved?: boolean;
  pdfBytes?: Blob;
  signedPdfBase64?: string;
  showPreview?: boolean;
}

@Component({
  selector: 'app-report-list',
  templateUrl: './report-list.component.html',
  styleUrls: ['./report-list.component.scss']
})
export class ReportListComponent implements OnInit {

  reports: ReportItem[] = [
    { id: 1, name: 'Rapor 1', dataId: 'data-1', selected: false },
    { id: 2, name: 'Rapor 2', dataId: 'data-2', selected: false },
    { id: 3, name: 'Rapor 3', dataId: 'data-3', selected: false },
    { id: 4, name: 'Rapor 4', dataId: 'data-4', selected: false },
  ];

  reviewingReports: ReportItem[] = [];
  approvedReports: ReportItem[] = [];
  
  isReviewMode: boolean = false;
  isSigningInProgress: boolean = false;
  signingProgress: string = '';
  errorMessage: string = '';
  successMessage: string = '';

  constructor(
    private fileUploadService: IFileUploadService,
    private wsESignatureService: WebSocketESignatureService
  ) { }

  ngOnInit() { }

  getSelectedCount(): number {
    return this.reports.filter(r => r.selected).length;
  }

  getApprovedCount(): number {
    return this.approvedReports.length;
  }

  onReviewSelected() {
    const selected = this.reports.filter(r => r.selected);
    
    if (selected.length === 0) {
      alert('LÃ¼tfen en az bir rapor seÃ§in');
      return;
    }

    console.log('ğŸ“‹ ' + selected.length + ' rapor seÃ§ildi, inceleme baÅŸlÄ±yor...');
    
    this.isReviewMode = true;
    this.reviewingReports = selected.slice();
    this.approvedReports = [];
    
    this.reviewingReports.forEach((report, index) => {
      report.showPreview = true;
    });
  }

  onPdfDecision(event: { dataId: string, decision: 'save' | 'cancel', pdfBytes?: Blob }) {
    const report = this.reviewingReports.find(r => r.dataId === event.dataId);
    
    if (!report) return;

    report.showPreview = false;

    if (event.decision === 'save') {
      report.approved = true;
      report.pdfBytes = event.pdfBytes;
      this.approvedReports.push(report);
      console.log('âœ… ' + report.name + ' onaylandÄ±');
    } else {
      report.approved = false;
      report.selected = false;
      console.log('âŒ ' + report.name + ' vazgeÃ§ildi');
    }

    const allReviewed = this.reviewingReports.every(r => !r.showPreview);
    
    if (allReviewed) {
      this.onReviewCompleted();
    }
  }

  private onReviewCompleted() {
    const that = this;
    console.log('ğŸ“Š Ä°nceleme tamamlandÄ±: ' + this.approvedReports.length + '/' + this.reviewingReports.length + ' onaylandÄ±');
    
    setTimeout(() => {
      that.isReviewMode = false;
    }, 500);
    
    if (this.approvedReports.length === 0) {
      alert('HiÃ§bir rapor onaylanmadÄ±');
    } else {
      this.successMessage = this.approvedReports.length + ' rapor onaylandÄ±. "SeÃ§ilenleri Onayla ve Ä°mzala" butonuna tÄ±klayarak imzalayabilirsiniz.';
      
      setTimeout(() => {
        that.successMessage = '';
      }, 5000);
    }
  }

  onApproveAndSign() {
    const that = this;
    
    if (this.approvedReports.length === 0) {
      alert('OnaylanmÄ±ÅŸ rapor yok');
      return;
    }

    this.isSigningInProgress = true;
    this.errorMessage = '';
    this.successMessage = '';
    this.signingProgress = '';

    console.log('ğŸ”Œ WebSocket baÄŸlantÄ±sÄ± kuruluyor...');
    this.signingProgress = 'WebSocket baÄŸlantÄ±sÄ± kuruluyor...';
    
    this.wsESignatureService.connectAsync('angular_user_' + Date.now()).then(
      function(connected) {
        if (!connected) {
          throw new Error('WebSocket baÄŸlantÄ±sÄ± kurulamadÄ±');
        }

        console.log('âœ… WebSocket baÄŸlandÄ±');
        console.log('ğŸ“„ PDF\'ler base64\'e Ã§evriliyor...');
        that.signingProgress = that.approvedReports.length + ' PDF base64\'e Ã§evriliyor...';
        
        return that.convertPdfsToBase64();
      }
    ).then(
      function(pdfBase64Array) {
        const combinedPdfBase64 = pdfBase64Array.join(';');
        console.log('ğŸ“¦ ' + pdfBase64Array.length + ' PDF birleÅŸtirildi, toplam uzunluk: ' + combinedPdfBase64.length);

        that.wsESignatureService.sendCardType('akisp11.dll');

        that.signingProgress = 'PDF\'ler imzalanÄ±yor... (LÃ¼tfen PIN giriniz)';
        console.log('ğŸ” Ä°mzalama baÅŸlatÄ±lÄ±yor...');
        
        return that.waitForSignature(combinedPdfBase64);
      }
    ).then(
      function(signedData) {
        const signedPdfArray = signedData.split(';');
        console.log('âœ… ' + signedPdfArray.length + ' imzalÄ± PDF alÄ±ndÄ±');

        if (signedPdfArray.length !== that.approvedReports.length) {
          throw new Error('Ä°mzalÄ± PDF sayÄ±sÄ± eÅŸleÅŸmiyor: ' + signedPdfArray.length + ' !== ' + that.approvedReports.length);
        }

        for (let i = 0; i < that.approvedReports.length; i++) {
          that.approvedReports[i].signedPdfBase64 = signedPdfArray[i];
        }

        that.signingProgress = 'Ä°mzalÄ± PDF\'ler sunucuya yÃ¼kleniyor...';
        return that.uploadSignedPdfs();
      }
    ).then(
      function() {
        that.isSigningInProgress = false;
        that.successMessage = 'âœ… ' + that.approvedReports.length + ' PDF baÅŸarÄ±yla imzalandÄ± ve yÃ¼klendi!';
        console.log('ğŸ‰ TÃ¼m iÅŸlemler tamamlandÄ±!');

        that.wsESignatureService.disconnect();

        setTimeout(() => {
          that.resetSelection();
        }, 3000);
      }
    ).catch(
      function(error) {
        console.error('âŒ Hata:', error);
        that.errorMessage = error.message || 'Ä°mzalama iÅŸlemi baÅŸarÄ±sÄ±z';
        that.isSigningInProgress = false;
        that.wsESignatureService.disconnect();
      }
    );
  }

  private convertPdfsToBase64(): Promise<string[]> {
    const that = this;
    const promises = [];
    
    for (let i = 0; i < this.approvedReports.length; i++) {
      const report = this.approvedReports[i];
      promises.push(that.blobToBase64(report.pdfBytes));
    }
    
    return Promise.all(promises);
  }

  private waitForSignature(pdfBase64: string): Promise<string> {
    const that = this;
    
    return new Promise((resolve, reject) => {
      const subscription = that.wsESignatureService.getMessages().subscribe(
        (response) => {
          if (response.hataMesaji) {
            subscription.unsubscribe();
            reject(new Error(response.hataMesaji));
          } else if (response.islemId === '12' || response.islemId === '2') {
            subscription.unsubscribe();
            resolve(response.data);
          }
        },
        (error) => {
          subscription.unsubscribe();
          reject(error);
        }
      );

      setTimeout(() => {
        that.wsESignatureService.signWithCAdESUI(pdfBase64, false);
      }, 500);

      setTimeout(() => {
        subscription.unsubscribe();
        reject(new Error('Ä°mzalama zaman aÅŸÄ±mÄ±na uÄŸradÄ± (60 saniye)'));
      }, 60000);
    });
  }

  private uploadSignedPdfs(): Promise<void> {
    const that = this;
    console.log('ğŸ“¤ ' + this.approvedReports.length + ' imzalÄ± PDF sunucuya yÃ¼kleniyor...');
    
    let promise = Promise.resolve();
    
    for (let i = 0; i < this.approvedReports.length; i++) {
      const index = i;
      const report = this.approvedReports[index];
      
      promise = promise.then(function() {
        that.signingProgress = 'YÃ¼kleniyor: ' + (index + 1) + '/' + that.approvedReports.length + ' - ' + report.name;
        
        const formData = new FormData();
        const blob = that.b64toBlob(report.signedPdfBase64, 'application/pdf');
        formData.append('PdfBytes', blob);
        formData.append('DataId', report.dataId);
        
        return that.fileUploadService.uploadFile(formData).toPromise().then(function() {
          console.log('âœ… ' + report.name + ' yÃ¼klendi');
        });
      });
    }
    
    return promise.then(function() {
      console.log('âœ… TÃ¼m PDF\'ler yÃ¼klendi');
    });
  }

  private resetSelection() {
    this.reports.forEach(r => {
      r.selected = false;
      r.approved = false;
      r.pdfBytes = null;
      r.signedPdfBase64 = null;
      r.showPreview = false;
    });
    this.reviewingReports = [];
    this.approvedReports = [];
    this.isReviewMode = false;
  }

  getZIndex(index: number): number {
    return 1000 + index;
  }

  private blobToBase64(blob: Blob): Promise<string> {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onloadend = () => {
        const base64String = reader.result as string;
        const base64 = base64String.split(',')[1];
        resolve(base64);
      };
      reader.onerror = reject;
      reader.readAsDataURL(blob);
    });
  }

  private b64toBlob(b64Data: string, contentType: string, sliceSize: number): Blob {
    contentType = contentType || '';
    sliceSize = sliceSize || 512;
    
    const byteCharacters = atob(b64Data);
    const byteArrays = [];
    
    for (let offset = 0; offset < byteCharacters.length; offset += sliceSize) {
      const slice = byteCharacters.slice(offset, offset + sliceSize);
      const byteNumbers = new Array(slice.length);
      
      for (let i = 0; i < slice.length; i++) {
        byteNumbers[i] = slice.charCodeAt(i);
      }
      
      const byteArray = new Uint8Array(byteNumbers);
      byteArrays.push(byteArray);
    }
    
    return new Blob(byteArrays, { type: contentType });
  }

}
```

---

## ğŸ“ Dosya 6: report-list.component.html

**Konum:** `src/app/components/report-list/report-list.component.html`

```html
<div class="report-list-container">
  <h2>Rapor Listesi</h2>

  <div class="report-list">
    <div class="report-item" *ngFor="let report of reports">
      <label>
        <input 
          type="checkbox" 
          [(ngModel)]="report.selected"
          [disabled]="isSigningInProgress || isReviewMode">
        <span [class.approved]="report.approved === true" 
              [class.rejected]="report.approved === false">
          {{ report.name }}
          <span *ngIf="report.approved === true" class="badge badge-success">âœ“ OnaylandÄ±</span>
          <span *ngIf="report.approved === false" class="badge badge-secondary">âœ— VazgeÃ§ildi</span>
        </span>
      </label>
    </div>
  </div>

  <div class="alert alert-danger" *ngIf="errorMessage">
    <i class="fa fa-exclamation-circle"></i>
    {{ errorMessage }}
  </div>

  <div class="alert alert-success" *ngIf="successMessage">
    <i class="fa fa-check-circle"></i>
    {{ successMessage }}
  </div>

  <div class="alert alert-info" *ngIf="signingProgress">
    <i class="fa fa-spinner fa-spin"></i>
    {{ signingProgress }}
  </div>

  <div class="review-summary" *ngIf="approvedReports.length > 0 && !isReviewMode">
    <h4>Ä°nceleme SonuÃ§larÄ±:</h4>
    <p>
      <strong>Onaylanan:</strong> {{ getApprovedCount() }} rapor hazÄ±r
    </p>
  </div>

  <div class="action-buttons">
    <button 
      class="btn btn-primary"
      (click)="onReviewSelected()"
      [disabled]="getSelectedCount() === 0 || isSigningInProgress || isReviewMode">
      <i class="fa fa-eye"></i>
      SeÃ§ilenleri Ä°ncele ({{ getSelectedCount() }})
    </button>

    <button 
      class="btn btn-success"
      (click)="onApproveAndSign()"
      [disabled]="getApprovedCount() === 0 || isSigningInProgress || isReviewMode">
      <i class="fa fa-signature"></i>
      SeÃ§ilenleri Onayla ve Ä°mzala ({{ getApprovedCount() }})
      <span class="spinner-border spinner-border-sm ml-2" *ngIf="isSigningInProgress"></span>
    </button>
  </div>

</div>

<app-pdf-preview 
  *ngFor="let report of reviewingReports; let i = index"
  [dataId]="report.dataId"
  [reportName]="report.name"
  [zIndex]="getZIndex(i)"
  (onDecision)="onPdfDecision($event)"
  [hidden]="!report.showPreview">
</app-pdf-preview>
```

---

## ğŸ“ Dosya 7: report-list.component.scss

**Konum:** `src/app/components/report-list/report-list.component.scss`

```scss
.report-list-container {
  padding: 20px;
  max-width: 800px;
  margin: 0 auto;

  h2 {
    margin-bottom: 20px;
    color: #333;
  }

  .report-list {
    background: white;
    border: 1px solid #ddd;
    border-radius: 8px;
    padding: 15px;
    margin-bottom: 20px;

    .report-item {
      padding: 10px;
      border-bottom: 1px solid #eee;

      &:last-child {
        border-bottom: none;
      }

      label {
        display: flex;
        align-items: center;
        cursor: pointer;
        margin: 0;

        input[type="checkbox"] {
          margin-right: 12px;
          width: 18px;
          height: 18px;
          cursor: pointer;

          &:disabled {
            cursor: not-allowed;
          }
        }

        span {
          font-size: 1rem;
          display: flex;
          align-items: center;
          gap: 10px;

          &.approved {
            color: #28a745;
            font-weight: 500;
          }

          &.rejected {
            color: #6c757d;
            text-decoration: line-through;
          }

          .badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;

            &.badge-success {
              background: #28a745;
              color: white;
            }

            &.badge-secondary {
              background: #6c757d;
              color: white;
            }
          }
        }
      }
    }
  }

  .alert {
    padding: 15px;
    border-radius: 6px;
    margin-bottom: 20px;
    display: flex;
    align-items: center;
    gap: 10px;

    i {
      font-size: 1.2rem;
    }

    &.alert-danger {
      background: #f8d7da;
      border: 1px solid #f5c6cb;
      color: #721c24;
    }

    &.alert-success {
      background: #d4edda;
      border: 1px solid #c3e6cb;
      color: #155724;
    }

    &.alert-info {
      background: #d1ecf1;
      border: 1px solid #bee5eb;
      color: #0c5460;
    }
  }

  .review-summary {
    background: #fff3cd;
    border: 1px solid #ffeaa7;
    border-radius: 6px;
    padding: 15px;
    margin-bottom: 20px;

    h4 {
      margin: 0 0 10px 0;
      font-size: 1.1rem;
      color: #856404;
    }

    p {
      margin: 0;
      color: #856404;
    }
  }

  .action-buttons {
    display: flex;
    gap: 12px;
    justify-content: flex-end;

    .btn {
      padding: 12px 24px;
      font-size: 1rem;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      gap: 8px;

      i {
        font-size: 1rem;
      }

      &:disabled {
        opacity: 0.6;
        cursor: not-allowed;
      }

      &.btn-primary {
        background: #007bff;
        color: white;

        &:hover:not(:disabled) {
          background: #0056b3;
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(0, 123, 255, 0.3);
        }
      }

      &.btn-success {
        background: #28a745;
        color: white;

        &:hover:not(:disabled) {
          background: #218838;
          transform: translateY(-1px);
          box-shadow: 0 4px 8px rgba(40, 167, 69, 0.3);
        }
      }

      .spinner-border {
        width: 1rem;
        height: 1rem;
        border-width: 0.15rem;
      }
    }
  }
}
```

---

## ğŸ“ Dosya 8: app.module.ts

**Konum:** `src/app/app.module.ts`

```typescript
import { BrowserModule } from '@angular/platform-browser';
import { NgModule } from '@angular/core';
import { FormsModule } from '@angular/forms';
import { HttpClientModule } from '@angular/common/http';
import { PdfViewerModule } from 'ng2-pdf-viewer';

import { AppComponent } from './app.component';
import { ReportListComponent } from './components/report-list/report-list.component';
import { PdfPreviewComponent } from './components/pdf-preview/pdf-preview.component';

// Services
import { WebSocketESignatureService } from './services/websocket-esignature.service';

@NgModule({
  declarations: [
    AppComponent,
    ReportListComponent,
    PdfPreviewComponent
  ],
  imports: [
    BrowserModule,
    FormsModule,
    HttpClientModule,
    PdfViewerModule
  ],
  providers: [
    WebSocketESignatureService
  ],
  bootstrap: [AppComponent]
})
export class AppModule { }
```

---

## ğŸ“ Dosya 9: mock-websocket-server.js

**Konum:** Proje root klasÃ¶rÃ¼nde (Angular projesinin dÄ±ÅŸÄ±nda)

```javascript
const WebSocket = require('ws');

const wss = new WebSocket.Server({ port: 5000 });

console.log('ğŸš€ Mock TurkTrust WebSocket Server baÅŸlatÄ±ldÄ±: ws://127.0.0.1:5000');

wss.on('connection', (ws) => {
  console.log('âœ… Yeni baÄŸlantÄ± kuruldu');

  ws.on('message', (message) => {
    try {
      const data = JSON.parse(message);
      console.log('ğŸ“¨ Gelen mesaj:', data);

      let response = {
        data: '',
        islemId: data.islemId,
        kullaniciId: data.kullaniciId,
        hataMesaji: '',
        sertifikaId: data.sertifikaId || '',
        akilliKartIsim: 'Test AkÄ±llÄ± Kart'
      };

      // Ä°ÅŸlem tipine gÃ¶re yanÄ±t
      switch (data.islemId) {
        case '1': // BaÄŸlantÄ± testi
          response.data = 'BaÄŸlantÄ± baÅŸarÄ±lÄ±!';
          break;
          
        case '9': // Kart tipi
          response.data = 'Kart kÃ¼tÃ¼phanesi ayarlandÄ±: ' + data.data;
          break;
          
        case '14': // CAdES tercihi
          response.data = 'CAdES tercihi kaydedildi';
          break;
          
        case '12': // Ä°mzalama
        case '2':
          // Gelen veriyi ; ile ayÄ±r
          const inputPdfs = data.data.split(';');
          console.log('ğŸ“ ' + inputPdfs.length + ' PDF imzalanÄ±yor...');
          
          // Her PDF iÃ§in mock imzalÄ± veri oluÅŸtur
          const signedPdfs = inputPdfs.map((pdf, index) => {
            return btoa('MOCK_SIGNED_PDF_' + (index + 1) + '_' + Date.now());
          });
          
          // ; ile birleÅŸtir
          response.data = signedPdfs.join(';');
          console.log('âœ… ' + signedPdfs.length + ' PDF imzalandÄ±');
          break;
          
        default:
          response.data = 'Ä°ÅŸlem tamamlandÄ±';
      }

      console.log('ğŸ“¤ GÃ¶nderilen yanÄ±t:', {
        islemId: response.islemId,
        dataLength: response.data.length
      });
      
      ws.send(JSON.stringify(response));

    } catch (error) {
      console.error('âŒ Hata:', error);
      ws.send(JSON.stringify({
        data: '',
        hataMesaji: 'Sunucu hatasÄ±: ' + error.message
      }));
    }
  });

  ws.on('close', () => {
    console.log('âŒ BaÄŸlantÄ± kapandÄ±');
  });
});
```

---

## ğŸ“ Dosya 10: KullanÄ±m KÄ±lavuzu (README.md)

```markdown
# ğŸ“š Toplu PDF Ä°mzalama Sistemi - KullanÄ±m KÄ±lavuzu

## ğŸš€ Kurulum

### 1. Paketleri YÃ¼kle
```bash
npm install ng2-pdf-viewer --save
npm install ws --save-dev
```

### 2. Dosya YapÄ±sÄ±
```
src/app/
â”œâ”€â”€ services/
â”‚   â””â”€â”€ websocket-esignature.service.ts
â”œâ”€â”€ components/
â”‚   â”œâ”€â”€ pdf-preview/
â”‚   â”‚   â”œâ”€â”€ pdf-preview.component.ts
â”‚   â”‚   â”œâ”€â”€ pdf-preview.component.html
â”‚   â”‚   â””â”€â”€ pdf-preview.component.scss
â”‚   â””â”€â”€ report-list/
â”‚       â”œâ”€â”€ report-list.component.ts
â”‚       â”œâ”€â”€ report-list.component.html
â”‚       â””â”€â”€ report-list.component.scss
â””â”€â”€ app.module.ts

mock-websocket-server.js (proje root)
```

### 3. Component OluÅŸtur
```bash
ng generate component components/pdf-preview
ng generate component components/report-list
```

### 4. Mock Server Ã‡alÄ±ÅŸtÄ±r
```bash
# Terminal 1: Mock WebSocket Server
node mock-websocket-server.js

# Terminal 2: Angular
ng serve
```

## ğŸ¯ KullanÄ±m AkÄ±ÅŸÄ±

### AdÄ±m 1: Ä°nceleme
1. Listeden PDF'leri seÃ§ (checkbox)
2. "SeÃ§ilenleri Ä°ncele" butonuna tÄ±kla
3. PDF'ler Ã¼st Ã¼ste popup olarak aÃ§Ä±lÄ±r
4. Her birinde "Kaydet" veya "VazgeÃ§" seÃ§
5. TÃ¼m kararlar verildikten sonra sonuÃ§ gÃ¶sterilir

### AdÄ±m 2: Toplu Ä°mzalama
1. "SeÃ§ilenleri Onayla ve Ä°mzala" butonuna tÄ±kla
2. WebSocket baÄŸlantÄ±sÄ± kurulur
3. TurkTrust PIN ekranÄ± aÃ§Ä±lÄ±r (1 kez)
4. TÃ¼m PDF'ler birlikte imzalanÄ±r
5. Ä°mzalÄ± PDF'ler sÄ±rayla sunucuya yÃ¼klenir
6. BaÅŸarÄ± mesajÄ± gÃ¶sterilir

## ğŸ”„ Veri AkÄ±ÅŸÄ±

```
PDF1, PDF2, PDF3 SeÃ§ildi
    â†“
Ä°NCELEME (Popup'lar Ã¼st Ã¼ste)
    â†“
PDF1: Kaydet âœ…
PDF2: VazgeÃ§ âŒ  
PDF3: Kaydet âœ…
    â†“
TOPLU Ä°MZALAMA
    â†“
Base64'e Ã§evir: [pdf1_base64, pdf3_base64]
BirleÅŸtir: "pdf1_base64;pdf3_base64"
    â†“
WebSocket'e gÃ¶nder
    â†“
TurkTrust PIN iste (1 kez)
    â†“
Ä°mzalÄ± veri al: "signed1;signed3"
AyÄ±r: [signed1, signed3]
    â†“
FOR dÃ¶ngÃ¼sÃ¼ ile yÃ¼kle:
  - Upload signed1 âœ…
  - Upload signed3 âœ…
    â†“
BAÅARILI âœ…
```

## ğŸ§ª Test SenaryolarÄ±

### Test 1: Tek PDF
```
1. 1 PDF seÃ§
2. Ä°ncele â†’ Kaydet
3. Onayla ve Ä°mzala
4. PIN gir
5. BaÅŸarÄ±lÄ± âœ…
```

### Test 2: Ã‡oklu PDF (Hepsi OnaylandÄ±)
```
1. 3 PDF seÃ§
2. Ä°ncele â†’ PDF1 Kaydet, PDF2 Kaydet, PDF3 Kaydet
3. Onayla ve Ä°mzala
4. PIN gir (1 kez)
5. 3 PDF birlikte imzalandÄ± âœ…
```

### Test 3: Ã‡oklu PDF (BazÄ±larÄ± Reddedildi)
```
1. 3 PDF seÃ§
2. Ä°ncele â†’ PDF1 Kaydet, PDF2 VazgeÃ§, PDF3 Kaydet
3. Onayla ve Ä°mzala
4. PIN gir (1 kez)
5. 2 PDF birlikte imzalandÄ± âœ…
```

## ğŸ“Š Console LoglarÄ±

```
ğŸ“‹ 3 rapor seÃ§ildi, inceleme baÅŸlÄ±yor...
âœ… Rapor 1 onaylandÄ±
âŒ Rapor 2 vazgeÃ§ildi
âœ… Rapor 3 onaylandÄ±
ğŸ“Š Ä°nceleme tamamlandÄ±: 2/3 onaylandÄ±

ğŸ”Œ WebSocket baÄŸlantÄ±sÄ± kuruluyor...
âœ… WebSocket baÄŸlandÄ±
ğŸ“„ PDF'ler base64'e Ã§evriliyor...
ğŸ“¦ 2 PDF birleÅŸtirildi, toplam uzunluk: 123456
ğŸ” Ä°mzalama baÅŸlatÄ±lÄ±yor...
ğŸ“¨ Mesaj alÄ±ndÄ±: { islemId: '12' }
âœ… 2 imzalÄ± PDF alÄ±ndÄ±
ğŸ“¤ 2 imzalÄ± PDF sunucuya yÃ¼kleniyor...
YÃ¼kleniyor: 1/2 - Rapor 1
âœ… Rapor 1 yÃ¼klendi
YÃ¼kleniyor: 2/2 - Rapor 3
âœ… Rapor 3 yÃ¼klendi
âœ… TÃ¼m PDF'ler yÃ¼klendi
ğŸ‰ TÃ¼m iÅŸlemler tamamlandÄ±!
```

## âš ï¸ Ã–nemli Notlar

1. **Angular 7 Uyumlu:** TÃ¼m kod Angular 7.0.3 iÃ§in yazÄ±lmÄ±ÅŸtÄ±r
2. **Modal Yok:** Component selector kullanÄ±larak popup gÃ¶rÃ¼nÃ¼mÃ¼
3. **Z-index:** PDF'ler Ã¼st Ã¼ste gÃ¶rÃ¼nÃ¼r (1000, 1001, 1002...)
4. **Tek PIN:** TÃ¼m PDF'ler iÃ§in sadece 1 kez PIN girilir
5. **NoktalÄ± virgÃ¼l (;):** PDF'ler birleÅŸtirilirken ayÄ±rÄ±cÄ±
6. **Promise Chain:** Angular 7 iÃ§in async/await yerine .then() kullanÄ±ldÄ±

## ğŸ‰ TamamlandÄ±!

Sistem hazÄ±r! Test edin ve baÅŸarÄ±larla kullanÄ±n! ğŸš€
```

---

## ğŸ¯ Ã–ZET

TÃ¼m dosyalar Angular 7 uyumlu olarak hazÄ±r:

âœ… **WebSocket Servisi** - Promise tabanlÄ±
âœ… **PDF Preview Component** - Popup gÃ¶rÃ¼nÃ¼mÃ¼  
âœ… **Report List Component** - Ana akÄ±ÅŸ yÃ¶netimi  
âœ… **SCSS** - Modern tasarÄ±m  
âœ… **Mock Server** - Test iÃ§in  
âœ… **Module** - FormsModule + PdfViewerModule  
âœ… **KÄ±lavuz** - KullanÄ±m talimatlarÄ±  

**Ã–zellikler:**
- âœ… Modal yok, component selector
- âœ… Ãœst Ã¼ste popup (z-index)
- âœ… Toplu imzalama (;)
